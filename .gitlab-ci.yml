# =============================================================================
# MiniFi‚Ñ¢ - GitLab CI/CD Pipeline
# Automatic deployment to Vercel (Frontend) & Render (Backend)
# Copyright (c) 2025 NUVC.AI / Tick.AI. All Rights Reserved.
# =============================================================================

stages:
  - validate
  - test
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.11"
  
# =============================================================================
# CACHE CONFIGURATION
# =============================================================================
.node_cache: &node_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-node
    paths:
      - node_modules/
      - .next/cache/

.python_cache: &python_cache
  cache:
    key: ${CI_COMMIT_REF_SLUG}-python
    paths:
      - .pip-cache/

# =============================================================================
# STAGE: VALIDATE
# =============================================================================
lint:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  script:
    - npm ci --prefer-offline
    - npm run lint || true
  only:
    - main
    - merge_requests
    - v1.2-release
  allow_failure: true

typecheck:
  stage: validate
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  script:
    - npm ci --prefer-offline
    - npx tsc --noEmit
  only:
    - main
    - merge_requests
    - v1.2-release

# =============================================================================
# STAGE: TEST
# =============================================================================
test:frontend:
  stage: test
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  script:
    - npm ci --prefer-offline
    - npm run test --passWithNoTests 2>/dev/null || echo "No tests configured yet"
  only:
    - main
    - merge_requests
    - v1.2-release
  allow_failure: true

test:backend:
  stage: test
  image: python:${PYTHON_VERSION}-slim
  <<: *python_cache
  before_script:
    - pip install --cache-dir=.pip-cache -r backend/requirements.txt
    - pip install --cache-dir=.pip-cache pytest httpx
  script:
    - cd backend
    - python -c "from main import app; print('Backend imports OK')"
    - pytest tests/ --ignore=tests/integration 2>/dev/null || echo "No tests configured yet"
  only:
    - main
    - merge_requests
    - v1.2-release
  allow_failure: true

# =============================================================================
# STAGE: BUILD
# =============================================================================
build:frontend:
  stage: build
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  script:
    - npm ci --prefer-offline
    - npm run build
  artifacts:
    paths:
      - .next/
    expire_in: 1 hour
  only:
    - main
    - v1.2-release

build:backend:
  stage: build
  image: python:${PYTHON_VERSION}-slim
  <<: *python_cache
  script:
    - pip install --cache-dir=.pip-cache -r backend/requirements.txt
    - cd backend && python -c "from main import app; print('Build OK')"
  only:
    - main
    - v1.2-release

# =============================================================================
# STAGE: DEPLOY - PRODUCTION
# =============================================================================
deploy:vercel:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  before_script:
    - npm install -g vercel
  script:
    - |
      echo "üöÄ Deploying Frontend to Vercel..."
      vercel pull --yes --environment=production --token=$VERCEL_TOKEN
      vercel build --prod --token=$VERCEL_TOKEN
      vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
  environment:
    name: production-frontend
    url: https://minifi.vercel.app
  only:
    - main
  when: manual
  needs:
    - build:frontend

deploy:vercel:auto:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  <<: *node_cache
  before_script:
    - npm install -g vercel
  script:
    - |
      echo "üöÄ Auto-deploying Frontend to Vercel..."
      vercel pull --yes --environment=production --token=$VERCEL_TOKEN
      vercel build --prod --token=$VERCEL_TOKEN
      DEPLOY_URL=$(vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN)
      echo "‚úÖ Deployed to: $DEPLOY_URL"
  environment:
    name: production-frontend
    url: https://minifi.vercel.app
  only:
    - v1.2-release
  needs:
    - build:frontend

deploy:render:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "üöÄ Triggering Render Backend Deployment..."
      curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
        -H "Authorization: Bearer $RENDER_API_KEY" \
        -H "Content-Type: application/json" \
        -d '{"clearCache": false}'
      echo "‚úÖ Render deployment triggered!"
  environment:
    name: production-backend
    url: https://minifi-backend.onrender.com
  only:
    - main
  when: manual
  needs:
    - build:backend

deploy:render:auto:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "üöÄ Auto-triggering Render Backend Deployment..."
      curl -X POST "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
        -H "Authorization: Bearer $RENDER_API_KEY" \
        -H "Content-Type: application/json" \
        -d '{"clearCache": false}'
      echo "‚úÖ Render deployment triggered!"
  environment:
    name: production-backend
    url: https://minifi-backend.onrender.com
  only:
    - v1.2-release
  needs:
    - build:backend

# =============================================================================
# STAGE: DEPLOY - STAGING (Preview)
# =============================================================================
deploy:preview:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm install -g vercel
  script:
    - |
      echo "üîç Deploying Preview to Vercel..."
      vercel pull --yes --environment=preview --token=$VERCEL_TOKEN
      vercel build --token=$VERCEL_TOKEN
      PREVIEW_URL=$(vercel deploy --prebuilt --token=$VERCEL_TOKEN)
      echo "‚úÖ Preview deployed to: $PREVIEW_URL"
      echo "PREVIEW_URL=$PREVIEW_URL" >> deploy.env
  artifacts:
    reports:
      dotenv: deploy.env
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    url: $PREVIEW_URL
    on_stop: stop:preview
  only:
    - merge_requests
  except:
    - main

stop:preview:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Preview environment stopped"
  environment:
    name: preview/$CI_COMMIT_REF_SLUG
    action: stop
  when: manual
  only:
    - merge_requests
  except:
    - main

# =============================================================================
# NOTIFICATIONS
# =============================================================================
notify:success:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "‚úÖ Deployment successful!"
      # Uncomment to enable Slack notifications:
      # curl -X POST -H 'Content-type: application/json' \
      #   --data '{"text":"‚úÖ MiniFi deployed successfully to production!"}' \
      #   $SLACK_WEBHOOK_URL
  only:
    - main
    - v1.2-release
  when: on_success

notify:failure:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      echo "‚ùå Deployment failed!"
      # Uncomment to enable Slack notifications:
      # curl -X POST -H 'Content-type: application/json' \
      #   --data '{"text":"‚ùå MiniFi deployment failed! Check pipeline."}' \
      #   $SLACK_WEBHOOK_URL
  only:
    - main
    - v1.2-release
  when: on_failure

